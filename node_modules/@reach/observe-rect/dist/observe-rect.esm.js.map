{"version":3,"file":"observe-rect.esm.js","sources":["../src/index.ts"],"sourcesContent":["let props: (keyof DOMRect)[] = [\n  'bottom',\n  'height',\n  'left',\n  'right',\n  'top',\n  'width'\n];\n\nlet rectChanged = (a: DOMRect = {} as DOMRect, b: DOMRect = {} as DOMRect) =>\n  props.some(prop => a[prop] !== b[prop]);\n\nlet observedNodes = new Map<HTMLElement, RectProps>();\nlet rafId: number;\n\nlet run = () => {\n  const changedStates: RectProps[] = [];\n  observedNodes.forEach((state, node) => {\n    let newRect = node.getBoundingClientRect();\n    if (rectChanged(newRect, state.rect)) {\n      state.rect = newRect;\n      changedStates.push(state);\n    }\n  });\n\n  changedStates.forEach(state => {\n    state.callbacks.forEach(cb => cb(state.rect));\n  });\n\n  rafId = window.requestAnimationFrame(run);\n};\n\nexport default function observeRect(\n  node: HTMLElement,\n  cb: (rect: DOMRect) => void\n) {\n  return {\n    observe() {\n      let wasEmpty = observedNodes.size === 0;\n      if (observedNodes.has(node)) {\n        observedNodes.get(node)!.callbacks.push(cb);\n      } else {\n        observedNodes.set(node, {\n          rect: undefined,\n          hasRectChanged: false,\n          callbacks: [cb]\n        });\n      }\n      if (wasEmpty) run();\n    },\n\n    unobserve() {\n      let state = observedNodes.get(node);\n      if (state) {\n        // Remove the callback\n        const index = state.callbacks.indexOf(cb);\n        if (index >= 0) state.callbacks.splice(index, 1);\n\n        // Remove the node reference\n        if (!state.callbacks.length) observedNodes.delete(node);\n\n        // Stop the loop\n        if (!observedNodes.size) cancelAnimationFrame(rafId);\n      }\n    }\n  };\n}\n\nexport type PartialRect = Partial<DOMRect>;\n\nexport type RectProps = {\n  rect: DOMRect | undefined;\n  hasRectChanged: boolean;\n  callbacks: Function[];\n};\n"],"names":["props","rectChanged","a","b","some","prop","observedNodes","Map","rafId","run","changedStates","forEach","state","node","newRect","getBoundingClientRect","rect","push","callbacks","cb","window","requestAnimationFrame","observeRect","observe","wasEmpty","size","has","get","set","undefined","hasRectChanged","unobserve","index","indexOf","splice","length","cancelAnimationFrame"],"mappings":"AAAA,IAAIA,KAAK,GAAsB,CAC7B,QAD6B,EAE7B,QAF6B,EAG7B,MAH6B,EAI7B,OAJ6B,EAK7B,KAL6B,EAM7B,OAN6B,CAA/B;;AASA,IAAIC,WAAW,GAAG,SAAdA,WAAc,CAACC,CAAD,EAA6BC,CAA7B;AAAC,kBAAA,EAAA;AAAAD,IAAAA,IAAa,EAAb;;;AAA4B,kBAAA,EAAA;AAAAC,IAAAA,IAAa,EAAb;;;AAC7C,SAAAH,KAAK,CAACI,IAAN,CAAW,UAAAC,IAAA;AAAQ,WAAAH,CAAC,CAACG,IAAD,CAAD,KAAYF,CAAC,CAACE,IAAD,CAAb;AAAmB,GAAtC,CAAA;AAAuC,CADzC;;AAGA,IAAIC,aAAa;AAAA;AAAG,IAAIC,GAAJ,EAApB;AACA,IAAIC,KAAJ;;AAEA,IAAIC,GAAG,GAAG,SAANA,GAAM;AACR,MAAMC,aAAa,GAAgB,EAAnC;AACAJ,EAAAA,aAAa,CAACK,OAAd,CAAsB,UAACC,KAAD,EAAQC,IAAR;AACpB,QAAIC,OAAO,GAAGD,IAAI,CAACE,qBAAL,EAAd;;AACA,QAAId,WAAW,CAACa,OAAD,EAAUF,KAAK,CAACI,IAAhB,CAAf,EAAsC;AACpCJ,MAAAA,KAAK,CAACI,IAAN,GAAaF,OAAb;AACAJ,MAAAA,aAAa,CAACO,IAAd,CAAmBL,KAAnB;AACD;AACF,GAND;AAQAF,EAAAA,aAAa,CAACC,OAAd,CAAsB,UAAAC,KAAA;AACpBA,IAAAA,KAAK,CAACM,SAAN,CAAgBP,OAAhB,CAAwB,UAAAQ,EAAA;AAAM,aAAAA,EAAE,CAACP,KAAK,CAACI,IAAP,CAAF;AAAc,KAA5C;AACD,GAFD;AAIAR,EAAAA,KAAK,GAAGY,MAAM,CAACC,qBAAP,CAA6BZ,GAA7B,CAAR;AACD,CAfD;;SAiBwBa,YACtBT,MACAM;AAEA,SAAO;AACLI,IAAAA,OAAO,EAAP;AACE,UAAIC,QAAQ,GAAGlB,aAAa,CAACmB,IAAd,KAAuB,CAAtC;;AACA,UAAInB,aAAa,CAACoB,GAAd,CAAkBb,IAAlB,CAAJ,EAA6B;AAC3BP,QAAAA,aAAa,CAACqB,GAAd,CAAkBd,IAAlB,EAAyBK,SAAzB,CAAmCD,IAAnC,CAAwCE,EAAxC;AACD,OAFD,MAEO;AACLb,QAAAA,aAAa,CAACsB,GAAd,CAAkBf,IAAlB,EAAwB;AACtBG,UAAAA,IAAI,EAAEa,SADgB;AAEtBC,UAAAA,cAAc,EAAE,KAFM;AAGtBZ,UAAAA,SAAS,EAAE,CAACC,EAAD;AAHW,SAAxB;AAKD;;AACD,UAAIK,QAAJ,EAAcf,GAAG;AAClB,KAbI;AAeLsB,IAAAA,SAAS;AACP,UAAInB,KAAK,GAAGN,aAAa,CAACqB,GAAd,CAAkBd,IAAlB,CAAZ;;AACA,UAAID,KAAJ,EAAW;AACT;AACA,YAAMoB,KAAK,GAAGpB,KAAK,CAACM,SAAN,CAAgBe,OAAhB,CAAwBd,EAAxB,CAAd;AACA,YAAIa,KAAK,IAAI,CAAb,EAAgBpB,KAAK,CAACM,SAAN,CAAgBgB,MAAhB,CAAuBF,KAAvB,EAA8B,CAA9B,EAHP;;AAMT,YAAI,CAACpB,KAAK,CAACM,SAAN,CAAgBiB,MAArB,EAA6B7B,aAAa,UAAb,CAAqBO,IAArB,EANpB;;AAST,YAAI,CAACP,aAAa,CAACmB,IAAnB,EAAyBW,oBAAoB,CAAC5B,KAAD,CAApB;AAC1B;AACF;AA5BI,GAAP;AA8BD;;;;"}